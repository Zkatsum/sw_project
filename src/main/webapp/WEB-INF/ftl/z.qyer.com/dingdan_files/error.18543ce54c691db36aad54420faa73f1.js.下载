window.Zworld=window.Zworld||{qyerUtil:{},settings:{},behaviors:{},mods:{},events:{}},window.console=window.console||{},function(t,e){Zworld.$proxy=t({}),Zworld.attachBehaviors=function(e,a){var e=e||[],n=n||Zworld.settings,a=a||"attach";t.each(e,function(){var e=this,n=t(".mod[data-mod-id="+e.id+"]");e.attach(e._$mod,n,a)})},Zworld.init=function(e,a){var e=e||[],n=n||Zworld.settings,a=a||"load";t.each(e,function(){var e=this,n=t(".mod[data-mod-id="+e.id+"]");e.init(e._$mod,n,a)})},Zworld.subscribe=function(t,a){var n=Zworld.events[t]||[];n.push(a),Zworld.events[t]=e.uniq(n)},Zworld.unsubscribe=function(t,a){var n=Zworld.events[t]||[];Zworld.events[t]=e.without(n,a)},Zworld.trigger=function(e,a){Zworld.$proxy.triggerHandler(e,a);var n=Zworld.events[e];n&&t.isArray(n)&&t.each(n,function(){var t=this,n=Zworld.mods[t]._$mod;n.triggerHandler(e,a)})},Zworld.on=function(t,e){return Zworld.$proxy.on(t,e)},Zworld.attachMod=function(e){if(!e)throw"error mod";var e=e||{},a=e.id,n=e.subscribe||[];e.load,e.attach;e._$mod=t({}),Zworld.mods[a]=e;for(var r=0,o=n.length;r<o;r++){var i=n[r];Zworld.subscribe(i,a)}},Zworld.cache={API:{addCoupon:function(t){return t.url="/bindCoupon",window.qyerUtil.doAjax(t)},searchFlight:function(t){return t.url="/flightinfo",window.qyerUtil.doAjax(t)},ajaxSubmit:function(t){return t.__qFED__={id:"2f49339d-4a5d-5b91-529e-116d16345da7",randomData:!0},window.qyerUtil.doAjax(t)}}},Zworld.toJSON=function(t){var e;try{e=JSON.parse(t)}catch(a){throw"error happend when processing data"}return e},Zworld.fixPrice=function(t){return/\.\d{2,}/.test(t)&&(t=t.toFixed(2)),t},Zworld.util={set_datepicker:function(e,a){require(["web_old_datepicker"],function(){e.size()&&e.each(function(){var e=t(this),n=e.attr("data-min"),r=e.attr("data-max"),o={},i={},d=function(t){return t+":"+(t+30)},l=function(t){return"1900:"+t};n&&(o.minDate=new Date(1e3*n),o.yearRange=d(o.minDate.getFullYear())),r&&(o.maxDate=new Date(1e3*r),o.yearRange=l(o.maxDate.getFullYear())),i=t.extend({},{changeYear:!0,changeMonth:!0,monthNamesShort:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],yearRange:"1900:"+((new Date).getFullYear()+30),onSelect:function(t){a&&a.onSelectCallback&&a.onSelectCallback(e,t)}},o),e.datepicker(i)})})},set_inputautocomplete:function(e,a){require(["web_old_inputautocomplete"],function(){e.size()&&e.each(function(e){var n=t(this);n.qyerAutocomplete({isAllowEmptySeach:!0,isFocusedSeach:!0,parent:n.parent()[0],onSearch:function(){var t=n.parent().find(".inputAutocomplete-hidden").html();n.qyerAutocomplete("pushHTML",t),a&&a.onSearchCallback&&a.onSearchCallback()},onSelect:function(e){var r=t(e);n.attr("data-selectkey",r.attr("data-key")).val(r.attr("data-value")),a&&a.onSelectCallback&&a.onSelectCallback(n,e)}})})})}},t(function(){var e=Zworld.mods||[];Zworld.attachBehaviors(e,"attach"),Zworld.init(e,"init"),Zworld.util.set_datepicker(t(".custom-datepicker input"),{onSelectCallback:function(t,e){"use_date"==t.parents(".input-ribbon").attr("data-key")&&(Zworld.cache.use_date=e)}}),Zworld.util.set_inputautocomplete(t('.mod-field[data-fetype$="select"] input[type="text"]'),{onSelectCallback:function(t,e){if("identity_type"==t.parents(".mod-field").attr("data-id"))for(var a=t.parents(".mod-prople"),n=a.attr("data-mod-id"),r=t.parents(".mod-"+n),o=[n+"_identity_num",n+"_identity_validity",n+"_identity_place"],i=r.find('.input-ribbon[data-key="'+n+'_identity_type"] input[type="text"]').attr("data-selectkey"),d=0,l=o.length;d<l;d++)if("99"==i)r.find(".input-ribbon[data-key='"+o[d]+"']").removeAttr("data-required").find("input").val("");else{r.find(".input-ribbon[data-key='"+o[d]+"']").attr("data-required",!0);var c=r.find('.input-ribbon[data-id="identity_num"]');if(!c.length)continue;"2"==i?c.attr("data-pattern","^((\\d{15})|(\\d{17}[\\dXx]{1}))$"):c.attr("data-pattern","^[0-9a-zA-Z]+$")}}})})}(jQuery,_);
$(function(){"use strict";var t=Zworld.cache.API;t.searchCountryCode=function(t){return t.__qFED__={id:"c6d487a6-86bd-6bfc-b40e-4e5af7b6e785",dataIndex:0},t.url="/qcross/www/u/ajax.php?action=SearchCountryCode",window.qyerUtil.doAjax(t)},require(["web_qui_quipopup","web_qui_quidialog","web_qui_quitip"],function(e,i,a){var n={init:function(){this.$form=$("#form"),this.$mask=$("#mask"),this.$page_hidden=$(".page-hidden"),this.$mod_unit=$(".mod-unit"),this.submit_data={},this.popup=null,this.valicode=null,this.initSubmitData(),this.initComponent(),this.bindEvt()},initSubmitData:function(){var t=this;this.submit_data={compon_data:{},contacts:{},message:{},modules:{},coupon_style:"",coupon:""},this.$page_hidden.find("input").each(function(e){var i=$(this),a=i.attr("id"),n=i.val();t.submit_data[a]=n});var e=$("#compon_data option");e.each(function(e,i){t.submit_data.compon_data[i.text]=i.value})},initComponent:function(){this.placeAside();var e={data:{action:"SearchCountryCode"},type:"post",onSuccess:function(t){for(var e,e,i,a,n,o,s=t.data.code,d=[],r=$("#phone-code"),n=0,o=s.length;n<o;n++)e=s[n],i=e.code.replace(/\+?(00)?/,""),a=e.name,d.push('<li data-value="'+i+'" ><a href="javascript:;">'+a+"("+i+")</a></li>");r.find(".contents > ul").html(d.join("")),s=d=e=i=n=o=null},onError:function(t){}};t.searchCountryCode(e),require(["web_old_select"],function(){$(".phone-code").qyerSelect({onChange:function(t){var e=t.getAttribute("data-value");$("#input-phone-code");$(this).qyerSelect("setTitle",e),$(this).siblings(":hidden[name=area_code]").val(t.getAttribute("data-value"))}})})},bindEvt:function(){var t=this;$(document).on("click",function(t){$(t.target).closest(".mod-field").size()<1&&$(".focus:eq(0)").removeClass("focus")}).on("click",".mod-fields .mod-field",function(){$(".focus").removeClass("focus"),$(this).addClass("focus").find(".input-hint").slideUp()}).on("focus","input",function(){$(".focus").removeClass("focus"),$(this).parents(".mod-field").addClass("focus").find(".input-hint").slideUp()}).on("click",".js-submit",function(){var e=t.validate();if(e.validate)qyerUtil.isLogin()?t.specialActivityChecker(t.submitData):require(["require_valicode"],function(e){t.valicode||(t.valicode=e.init({onConfirmCallback:function(){t.specialActivityChecker(t.submitData)}})),t.valicode.showfast()});else try{$(window).scrollTop($(".input-hint:visible").offset().top-60)}catch(i){console.log(i)}}).on("click",".qui-popup-closeIcon",function(){$(".qui-popup").remove()})},showTip:function(t,e){require(["web_qui_quidialog"],function(i){(new i).alert({title:"提示",text:t,type:e||"error"})})},showMask:function(){this.$mask.show()},hideMask:function(){this.$mask.hide()},getFixTmieStr:function(t,e){return t&&1==t.length&&(t="0"+t),t},getValue:function(t){var e,i,a=t.attr("data-fetype");switch(a){case"radio":var n=t.find('input[type="radio"]:checked'),e=$.trim(n.val());i={val:e,readval:n.attr("data-name")};break;case"text_time":var n=t.find('input[type="text"]'),o=this.getFixTmieStr($.trim(n.eq(0).val()))+":"+this.getFixTmieStr($.trim(n.eq(1).val()));i={val:":"==o?"":o,readval:":"==o?"":o};break;case"select":var n=t.find('input[type="text"]'),e=$.trim(n.val());i={val:n.attr("data-selectkey"),readval:e};break;case"input_select":var n=t.find('input[type="text"]'),e=$.trim(n.val());i={val:e,readval:e};break;case"textarea":var n=t.find("textarea"),e=$.trim(n.val());i={val:e,readval:e};break;default:var n=t.find('input[type="text"]'),e=$.trim(n.val());t.hasClass("country-code")&&(e=$.trim(t.find("#phone-code .title-text").text())+"-"+e),i={val:e,readval:e}}return i},validate:function(){var t=this,e={validate:!0,items:{}};this.initSubmitData();var i=$(".mod[data-mod-id=coupon]");this.submit_data.coupon_style=i.attr("data-coupon-style"),this.submit_data.coupon=i.attr("data-coupon-no"),this.$mod_unit.find(".input-hint").slideUp(),this.$mod_unit.each(function(i){var a=$(this),n=a.parents(".mod"),o=n.attr("data-mod-id"),s=n.attr("data-mod-name"),d=!0,r=!1,l={mod_name:s,list:[]};if(a.is(".notice-wrapper")){var u=a.find('.custom-checkbox input[type="checkbox"]').is(":checked");return u?(d=!0,a.removeClass("error").find(".input-hint").hide()):(e.validate=d=!1,a.addClass("error").find(".input-hint").show()),!0}a.is(".mod-tourists")&&(r=!0),a.children().each(function(){var i=$(this),a=i.find(".input-ribbon:not(.ribbon-bind)"),n=i.find('.mod-bind-contact input[type="checkbox"]'),s=i.attr("data-equip-id"),u={title:i.find(".mod-title .vm").text(),content:{}};switch(n.length&&(u.is_bind=~~n.prop("checked")),i.find(".mod-title .vm").attr("compon-key")&&(u.compon_key=i.find(".mod-title .vm").attr("compon-key")),r&&s&&(u.id=~~s),a.each(function(i){var a,n,o=$(this),s=o.attr("data-id"),r=o.attr("data-name"),l=(o.attr("data-fetype"),o.attr("data-required")),c=o.attr("data-pattern"),h=o.attr("data-agelimit");if(a=t.getValue(o),n=$.extend({},a),o.hasClass("country-code")&&$.each(a,function(t,e){a[t]=e.split("-")[1]}),l&&"true"==l?!a.readval||$.trim(a.readval).length<1?(e.validate=d=!1,o.find(".input-hint").slideDown().find(".null").show().siblings().hide()):1!=new RegExp(c,"g").test(a.readval)&&(e.validate=d=!1,o.find(".input-hint").slideDown().find(".error").show().siblings().hide()):""!=a.readval&&1!=new RegExp(c,"g").test(a.readval)&&(e.validate=d=!1,o.find(".input-hint").slideDown().find(".error").show().siblings().hide()),h&&0!==h.length&&""!=a.readval){var f;if($("#use_date-0").length>0&&""!=$("#use_date-0").val())f=$("#use_date-0").val();else if(0==$("#use_date-0").length){var p=new Date(1e3*o.attr("today-date"))||new Date;f=1900+p.getYear()+"-"+(p.getMonth()+1)+"-"+p.getDate(),p=null}if(f&&""!=f){var v=h.split("-")[0],m=h.split("-")[1],b=a.readval.match(/^(\d{1,4})(-|\/)(\d{1,2})\2(\d{1,2})$/),_=f.match(/^(\d{1,4})(-|\/)(\d{1,2})\2(\d{1,2})$/);if(null==b||null==_)e.validate=d=!1,o.find(".input-hint").slideDown().find(".error").show().siblings().hide();else{var w=(new Date(b[1],b[3]-1,b[4]),parseInt(_[1])),g=parseInt(_[3]),y=parseInt(_[4]),C=w-b[1]-(g<parseInt(b[3])||g==b[3]&&y<parseInt(b[4])?1:0);(C>m||C<v)&&(e.validate=d=!1,o.find(".input-hint").slideDown().find(".refill-error").html("超出规定年龄范围，请重新选择").show().siblings().hide())}}}if("last_date"===s){var k=o.find("#use_last_date-0"),x=k.parents(".mod-fields").find("#use_date-0");if(k.length>0&&""!==k.val()&&x.length>0&&""!==x.val()){var q=new Date(k.val()),D=new Date(x.val());q>D&&(e.validate=d=!1,o.find(".input-hint").slideDown().find(".refill-error").html("收票时间不能大于使用时间").show().siblings().hide())}}o.hasClass("country-code")&&(a=n),u.content[s]={field_name:r,value:a.val,readable_value:a.readval}}),l.list.push(u),o){case"contacts":case"message":t.submit_data[o]=l;break;default:t.submit_data.modules[o]=l}})});var a=$(".js-raileuro-countries");return a.length>0&&""!=a.attr("raileuro-countries")&&(t.submit_data.country_list=Zworld.toJSON(a.attr("raileuro-countries"))),e},submitData:function(){var e=this,i=Zworld.cache.page_data.form_submit_url;if(i){e.showMask();var a={url:i,data:{submit_data:e.submit_data},onSuccess:function(t){$("#order_id").val(t.data.order_id),e.hideMask(),e.$form.submit()},onError:function(t){e.hideMask(),t.__server_error__?e.showTip("服务器错误，请稍后再试！"):1==t.error_code?window.location.href=t.data.error_url:e.showTip(t.data.msg||t.data)}};t.ajaxSubmit(a)}},placeAside:function(){var t=$(".aside"),e=$(".zw-wrapper .main");if(t.size()){var i=t.offset().top,a=t.height(),n=function(){var n=(t.offset().top,$(window).scrollTop()),o=$("body").height(),s=e.height(),d=o-i-s;return n>=i+10&&!t.hasClass("fixed")&&!t.hasClass("bottom")?void t.addClass("fixed"):n<i+10&&t.hasClass("fixed")?void t.removeClass("fixed"):o-n-a<=d&&!t.hasClass("bottom")?void t.removeClass("fixed").addClass("bottom").css("bottom",0):o-n-a>d&&t.hasClass("bottom")?void t.removeClass("bottom").addClass("fixed").css("bottom","inherit"):void 0};$(window).scroll(n)}},fillInputs:function(t,e){_.mapObject(e,function(e,i){$("#"+i,t).val(e)})},fillObject:function(t,e){return _.mapObject(t,function(t,i){return $("#"+i,e).val()})},specialActivityChecker:function(t){var e=this,i=[];_.isEmpty(i)&&t&&t.apply(e)}};n.init()})});